graph TB
    subgraph "DOMAIN LAYER - Understands DATA"
        IOPreviewPretty["IOPreviewPretty<br/>• Detect ChatML format<br/>• Detect Markdown<br/>• Estimate size<br/>• Parse data"]
        IOPreviewJSON["IOPreviewJSON<br/>• Skip ChatML parsing<br/>• Direct rendering"]
        TraceDetailView["TraceDetailView<br/>• Manage trace state<br/>• Handle tabs/view mode"]
        ObservationDetailView["ObservationDetailView<br/>• Manage observation state<br/>• Handle tabs/view mode"]
    end

    subgraph "COORDINATION LAYER - Makes DECISIONS"
        IODataViewer["IODataViewer<br/>• Route to JSON/Table viewer<br/>• Add Input/Output titles<br/>• Manage expansion state<br/>• NO domain logic"]
        MetadataViewer["MetadataViewer<br/>• Route to JSON/Table viewer<br/>• Add Metadata title<br/>• Manage expansion state<br/>• NO domain logic"]
    end

    subgraph "PRESENTATION LAYER - RENDERS"
        JSONViewer["JSONViewer<br/>• Virtualized JSON tree<br/>• react-obj-view<br/>• ~500-2K DOM nodes<br/>• NO domain knowledge"]
        TableViewer["TableViewer<br/>• Virtualized table<br/>• Path | Value columns<br/>• Smart expansion<br/>• NO domain knowledge"]
        SimpleDataViewer["SimpleDataViewer<br/>• Non-virtualized<br/>• For small data<br/>• Auto-expand all<br/>• NO domain knowledge"]
    end

    subgraph "CURRENT (To be replaced)"
        PrettyJsonView["PrettyJsonView<br/>⚠️ 1,422 lines<br/>⚠️ 139K+ DOM nodes<br/>⚠️ Mixed responsibilities<br/>⚠️ Domain + Presentation"]
    end

    %% Data flow from Domain to Coordination
    IOPreviewPretty -->|"format: ChatML/JSON<br/>data: parsed"| IODataViewer
    IOPreviewJSON -->|"data: parsed"| IODataViewer
    TraceDetailView -->|"data: metadata<br/>viewMode: json/pretty"| MetadataViewer
    ObservationDetailView -->|"data: metadata<br/>viewMode: json/pretty"| MetadataViewer

    %% Data flow from Coordination to Presentation
    IODataViewer -->|"viewMode === 'json'"| JSONViewer
    IODataViewer -->|"viewMode === 'pretty'"| TableViewer
    MetadataViewer -->|"viewMode === 'json'"| JSONViewer
    MetadataViewer -->|"viewMode === 'pretty'"| TableViewer

    %% Special cases
    IOPreviewPretty -.->|"tool args<br/>(small data)"| SimpleDataViewer

    %% Old flow (to be removed)
    IOPreviewPretty -.->|"❌ OLD (Week 4)"| PrettyJsonView
    TraceDetailView -.->|"❌ OLD (Week 2)"| PrettyJsonView
    ObservationDetailView -.->|"❌ OLD (Week 2)"| PrettyJsonView

    classDef domain fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef coordination fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef presentation fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef deprecated fill:#ffebee,stroke:#c62828,stroke-width:2px,stroke-dasharray: 5 5

    class IOPreviewPretty,IOPreviewJSON,TraceDetailView,ObservationDetailView domain
    class IODataViewer,MetadataViewer coordination
    class JSONViewer,TableViewer,SimpleDataViewer presentation
    class PrettyJsonView deprecated
